
<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EasyToll - Tolldeklarasjon med OCR</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:20px}
    .container{max-width:1100px;margin:0 auto}
    .card{background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden;margin-bottom:20px}
    .header{background:linear-gradient(135deg,#1e3a8a,#3b82f6);color:#fff;padding:24px;text-align:center}
    .header h1{font-size:28px;margin-bottom:6px}
    .header p{opacity:.9;font-size:14px}
    .badges{display:flex;justify-content:center;gap:8px;margin-top:14px;flex-wrap:wrap}
    .badge{background:rgba(255,255,255,.2);padding:6px 14px;border-radius:20px;font-size:12px}
    .content{padding:28px}
    .upload-area{text-align:center;margin-bottom:28px}
    .upload-zone{border:3px dashed #cbd5e1;border-radius:16px;padding:40px 24px;cursor:pointer;transition:all .3s;background:#f8fafc;max-width:500px;margin:0 auto}
    .upload-zone:hover{border-color:#3b82f6;background:#eff6ff}
    .upload-zone.dragover{border-color:#3b82f6;background:#dbeafe;transform:scale(1.02)}
    .upload-zone.has-file{border-color:#10b981;background:#ecfdf5;border-style:solid}
    .upload-zone.processing{pointer-events:none;opacity:.7}
    .upload-icon{font-size:48px;margin-bottom:12px}
    .upload-title{font-size:18px;font-weight:600;color:#1e293b;margin-bottom:6px}
    .upload-hint{color:#64748b;font-size:13px}
    .upload-formats{margin-top:12px;display:flex;justify-content:center;gap:6px}
    .format-tag{background:#e2e8f0;padding:4px 10px;border-radius:10px;font-size:11px;color:#475569}
    #fileInput{display:none}
    .btn-row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:16px}
    .btn{padding:12px 24px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;border:none;transition:all .2s}
    .btn-success{background:linear-gradient(135deg,#10b981,#059669);color:#fff}
    .btn-success:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(16,185,129,.4)}
    .btn-secondary{background:#f1f5f9;color:#475569;border:2px solid #e2e8f0}
    .btn-secondary:hover{background:#e2e8f0}
    .btn-primary{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:#fff}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(59,130,246,.4)}
    .progress-box{max-width:500px;margin:20px auto;padding:20px;background:#f0f9ff;border-radius:12px;border:1px solid #bae6fd;display:none}
    .progress-box.active{display:block}
    .progress-title{font-weight:600;color:#0369a1;margin-bottom:10px;display:flex;align-items:center;gap:8px}
    .spinner{width:18px;height:18px;border:3px solid #bae6fd;border-top-color:#0369a1;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .progress-bar{height:10px;background:#e0f2fe;border-radius:5px;overflow:hidden}
    .progress-fill{height:100%;background:linear-gradient(90deg,#0ea5e9,#0284c7);width:0%;transition:width .3s}
    .progress-status{margin-top:8px;font-size:12px;color:#0369a1}
    .preview-box{max-width:400px;margin:20px auto;display:none}
    .preview-box.active{display:block}
    .preview-img{max-width:100%;max-height:200px;border-radius:10px;border:2px solid #e2e8f0;display:block;margin:0 auto}
    .preview-name{text-align:center;margin-top:8px;font-size:13px;color:#64748b}
    #pdfCanvas{display:none}
    .alert{padding:14px 18px;border-radius:10px;margin-bottom:20px;font-size:14px;display:flex;align-items:flex-start;gap:10px}
    .alert-info{background:#eff6ff;border:1px solid #bfdbfe;color:#1e40af}
    .alert-success{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46}
    .alert-error{background:#fef2f2;border:1px solid #fecaca;color:#991b1b}
    .alert-warning{background:#fffbeb;border:1px solid #fde68a;color:#92400e}
    .results{display:none}
    .results.active{display:block}
    .section{margin-bottom:24px}
    .section-title{font-size:15px;font-weight:700;color:#1e293b;margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid #e2e8f0}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
    .field{background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:12px}
    .field.filled{background:#ecfdf5;border-color:#a7f3d0}
    .field-label{font-size:11px;font-weight:600;color:#64748b;text-transform:uppercase;margin-bottom:5px}
    .field-input{width:100%;padding:9px 11px;border:1px solid #e2e8f0;border-radius:6px;font-size:14px;background:#fff}
    .field-input:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.1)}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th{background:#f1f5f9;padding:10px 8px;text-align:left;font-weight:600;color:#475569;font-size:11px}
    td{padding:6px;border-bottom:1px solid #e2e8f0}
    td input{width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:5px;font-size:13px}
    td input:focus{outline:none;border-color:#3b82f6}
    .export-box{background:#f8fafc;border-radius:12px;padding:20px;margin-top:24px}
    .export-options{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px}
    .export-opt{padding:12px 8px;background:#fff;border:2px solid #e2e8f0;border-radius:8px;cursor:pointer;text-align:center;transition:all .2s;font-size:12px}
    .export-opt:hover{border-color:#cbd5e1}
    .export-opt.sel{border-color:#3b82f6;background:#eff6ff}
    .export-opt-icon{font-size:20px;margin-bottom:4px}
    .export-opt-label{font-weight:700}
    .preview-code{background:#1e293b;border-radius:8px;padding:14px;margin:12px 0;max-height:240px;overflow:auto}
    .preview-code pre{font-family:Consolas,Monaco,monospace;font-size:11px;color:#94a3b8;white-space:pre-wrap;word-break:break-all;margin:0;line-height:1.5}
    .footer{text-align:center;padding:20px;color:#fff;font-size:13px;opacity:.8}
    .footer a{color:#fff}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <h1>üìã EasyToll</h1>
        <p>Automatisk Tolldeklarasjon med OCR</p>
        <div class="badges">
          <span class="badge">üá≥üá¥ Norge</span>
          <span class="badge">TVINN / Digitoll</span>
          <span class="badge">PDF + Bilde OCR</span>
        </div>
      </div>
      
      <div class="content">
        <div id="alertBox" class="alert alert-info">
          üí° Last opp en faktura (<strong>PDF, PNG eller JPG</strong>) for automatisk utfylling.
        </div>
        
        <div class="upload-area">
          <div class="upload-zone" id="uploadZone">
            <div class="upload-icon">üìÑ</div>
            <div class="upload-title">Last opp faktura</div>
            <div class="upload-hint">Dra og slipp, eller klikk for √• velge</div>
            <div class="upload-formats">
              <span class="format-tag">PDF</span>
              <span class="format-tag">PNG</span>
              <span class="format-tag">JPG</span>
            </div>
          </div>
          <input type="file" id="fileInput" accept="image/*,.pdf,application/pdf">
          
          <div class="progress-box" id="progressBox">
            <div class="progress-title"><div class="spinner"></div> <span id="progressTitle">Behandler...</span></div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
            <div class="progress-status" id="progressStatus">Starter...</div>
          </div>
          
          <div class="preview-box" id="previewBox">
            <img id="previewImg" class="preview-img" alt="Forh√•ndsvisning">
            <div class="preview-name" id="fileName"></div>
          </div>
          <canvas id="pdfCanvas"></canvas>
          
          <div class="btn-row">
            <button class="btn btn-success" id="demoBtn">üéØ Last inn demodata</button>
            <button class="btn btn-secondary" id="resetBtn">üîÑ Nullstill</button>
          </div>
        </div>
        
        <div class="results" id="results">
          <div class="section">
            <div class="section-title">üìÑ Fakturainformasjon</div>
            <div class="grid">
              <div class="field" id="f_invNum"><div class="field-label">Fakturanummer</div><input type="text" class="field-input" id="invNum"></div>
              <div class="field" id="f_invDate"><div class="field-label">Fakturadato</div><input type="date" class="field-input" id="invDate"></div>
              <div class="field" id="f_invAmount"><div class="field-label">Bel√∏p</div><input type="number" step="0.01" class="field-input" id="invAmount"></div>
              <div class="field"><div class="field-label">Valuta</div>
                <select class="field-input" id="invCurrency">
                  <option value="EUR">EUR</option><option value="USD">USD</option><option value="GBP">GBP</option><option value="NOK">NOK</option><option value="SEK">SEK</option><option value="DKK">DKK</option><option value="CNY">CNY</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="section">
            <div class="section-title">üë• Parter</div>
            <div class="grid">
              <div class="field" id="f_expName"><div class="field-label">Avsender</div><input type="text" class="field-input" id="expName"></div>
              <div class="field"><div class="field-label">Avsenderland</div>
                <select class="field-input" id="expCountry">
                  <option value="">Velg...</option><option value="DE">Tyskland</option><option value="CN">Kina</option><option value="SE">Sverige</option><option value="GB">UK</option><option value="US">USA</option><option value="NL">Nederland</option><option value="DK">Danmark</option><option value="PL">Polen</option><option value="FR">Frankrike</option><option value="IT">Italia</option>
                </select>
              </div>
              <div class="field"><div class="field-label">Mottaker</div><input type="text" class="field-input" id="impName"></div>
              <div class="field"><div class="field-label">Org.nr</div><input type="text" class="field-input" id="impOrg" maxlength="9"></div>
            </div>
          </div>
          
          <div class="section">
            <div class="section-title">üöö Levering</div>
            <div class="grid">
              <div class="field"><div class="field-label">Incoterms</div>
                <select class="field-input" id="incoterms"><option value="">Velg...</option><option value="EXW">EXW</option><option value="FCA">FCA</option><option value="DAP">DAP</option><option value="DDP">DDP</option><option value="FOB">FOB</option><option value="CIF">CIF</option></select>
              </div>
              <div class="field"><div class="field-label">Transport</div>
                <select class="field-input" id="transport"><option value="">Velg...</option><option value="1">Sj√∏</option><option value="2">Jernbane</option><option value="3">Vei</option><option value="4">Luft</option></select>
              </div>
            </div>
          </div>
          
          <div class="section">
            <div class="section-title">üì¶ Varer</div>
            <div style="overflow-x:auto">
              <table>
                <thead><tr><th>#</th><th>Beskrivelse</th><th style="width:110px">HS-kode</th><th style="width:55px">Land</th><th style="width:70px">Vekt</th><th style="width:80px">Pris</th></tr></thead>
                <tbody id="itemsBody">
                  <tr><td>1</td><td><input type="text" id="item1_desc"></td><td><input type="text" id="item1_hs"></td><td><input type="text" id="item1_origin" maxlength="2"></td><td><input type="number" id="item1_weight"></td><td><input type="number" id="item1_price"></td></tr>
                </tbody>
              </table>
            </div>
            <button class="btn btn-secondary" onclick="addRow()" style="margin-top:10px;padding:8px 16px;font-size:12px">+ Legg til</button>
          </div>
          
          <div class="export-box">
            <div class="section-title" style="border:none;padding:0;margin-bottom:12px">üì§ Eksporter</div>
            <div class="export-options" id="exportOptions">
              <div class="export-opt sel" data-fmt="edifact"><div class="export-opt-icon">üìã</div><div class="export-opt-label">EDIFACT</div></div>
              <div class="export-opt" data-fmt="json"><div class="export-opt-icon">üì¶</div><div class="export-opt-label">JSON</div></div>
              <div class="export-opt" data-fmt="csv"><div class="export-opt-icon">üìä</div><div class="export-opt-label">CSV</div></div>
              <div class="export-opt" data-fmt="xml"><div class="export-opt-icon">üåê</div><div class="export-opt-label">XML</div></div>
            </div>
            <div class="preview-code"><pre id="output"></pre></div>
            <div class="btn-row" style="margin:0">
              <button class="btn btn-secondary" onclick="copyOut()">üìã Kopier</button>
              <button class="btn btn-primary" onclick="downloadOut()">‚¨áÔ∏è Last ned</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="footer">EasyToll Demo ‚Ä¢ <a href="https://toll.no" target="_blank">toll.no</a></div>
  </div>

  <!-- PDF.js for PDF support -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <!-- Tesseract.js for OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  
  <script>
    // Set PDF.js worker
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
    
    var fmt = 'edifact', rowCount = 1;
    
    var uploadZone = document.getElementById('uploadZone');
    var fileInput = document.getElementById('fileInput');
    var progressBox = document.getElementById('progressBox');
    var previewBox = document.getElementById('previewBox');
    var previewImg = document.getElementById('previewImg');
    var pdfCanvas = document.getElementById('pdfCanvas');
    var results = document.getElementById('results');
    var alertBox = document.getElementById('alertBox');
    
    // Upload handlers
    uploadZone.onclick = function() { fileInput.click(); };
    uploadZone.ondragover = function(e) { e.preventDefault(); uploadZone.classList.add('dragover'); };
    uploadZone.ondragleave = function(e) { e.preventDefault(); uploadZone.classList.remove('dragover'); };
    uploadZone.ondrop = function(e) { e.preventDefault(); uploadZone.classList.remove('dragover'); if(e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]); };
    fileInput.onchange = function() { if(fileInput.files[0]) handleFile(fileInput.files[0]); };
    
    function handleFile(file) {
      console.log('File:', file.name, file.type);
      document.getElementById('fileName').textContent = file.name;
      uploadZone.classList.add('has-file');
      
      var isPDF = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');
      
      if (isPDF) {
        processPDF(file);
      } else if (file.type.match(/image\//)) {
        processImage(file);
      } else {
        showAlert('error', 'Ugyldig filtype. Bruk PDF, PNG eller JPG.');
      }
    }
    
    function processPDF(file) {
      progressBox.classList.add('active');
      uploadZone.classList.add('processing');
      setProgress(5, 'Leser PDF...');
      
      var reader = new FileReader();
      reader.onload = function(e) {
        var typedArray = new Uint8Array(e.target.result);
        
        if (typeof pdfjsLib === 'undefined') {
          showAlert('error', 'PDF-bibliotek ikke lastet. Pr√∏v √• laste siden p√• nytt.');
          progressBox.classList.remove('active');
          uploadZone.classList.remove('processing');
          return;
        }
        
        setProgress(15, '√Öpner PDF...');
        
        pdfjsLib.getDocument(typedArray).promise.then(function(pdf) {
          setProgress(25, 'Henter side 1...');
          
          pdf.getPage(1).then(function(page) {
            setProgress(35, 'Rendrer PDF til bilde...');
            
            var scale = 2.0; // Higher = better OCR quality
            var viewport = page.getViewport({ scale: scale });
            
            pdfCanvas.width = viewport.width;
            pdfCanvas.height = viewport.height;
            
            var context = pdfCanvas.getContext('2d');
            
            page.render({
              canvasContext: context,
              viewport: viewport
            }).promise.then(function() {
              setProgress(50, 'PDF konvertert til bilde. Starter OCR...');
              
              // Show preview
              previewImg.src = pdfCanvas.toDataURL('image/png');
              previewBox.classList.add('active');
              
              // Run OCR on canvas
              runOCR(pdfCanvas);
              
            }).catch(function(err) {
              console.error('PDF render error:', err);
              showAlert('error', 'Kunne ikke rendre PDF: ' + err.message);
              progressBox.classList.remove('active');
              uploadZone.classList.remove('processing');
            });
            
          }).catch(function(err) {
            console.error('PDF page error:', err);
            showAlert('error', 'Kunne ikke lese PDF-side: ' + err.message);
            progressBox.classList.remove('active');
            uploadZone.classList.remove('processing');
          });
          
        }).catch(function(err) {
          console.error('PDF load error:', err);
          showAlert('error', 'Kunne ikke √•pne PDF: ' + err.message);
          progressBox.classList.remove('active');
          uploadZone.classList.remove('processing');
        });
      };
      reader.readAsArrayBuffer(file);
    }
    
    function processImage(file) {
      progressBox.classList.add('active');
      uploadZone.classList.add('processing');
      setProgress(10, 'Leser bilde...');
      
      var reader = new FileReader();
      reader.onload = function(e) {
        previewImg.src = e.target.result;
        previewBox.classList.add('active');
        setProgress(20, 'Starter OCR...');
        runOCR(file);
      };
      reader.readAsDataURL(file);
    }
    
    function runOCR(imageSource) {
      if (typeof Tesseract === 'undefined') {
        showAlert('error', 'OCR-motor ikke lastet. Pr√∏v √• laste siden p√• nytt.');
        progressBox.classList.remove('active');
        uploadZone.classList.remove('processing');
        return;
      }
      
      Tesseract.recognize(imageSource, 'eng', {
        logger: function(m) {
          if (m.status === 'loading tesseract core') setProgress(55, 'Laster OCR-kjerne...');
          else if (m.status === 'initializing tesseract') setProgress(60, 'Initialiserer OCR...');
          else if (m.status === 'loading language traineddata') setProgress(65, 'Laster spr√•kdata...');
          else if (m.status === 'initializing api') setProgress(70, 'Starter tekstgjenkjenning...');
          else if (m.status === 'recognizing text') {
            var pct = Math.round(70 + m.progress * 25);
            setProgress(pct, 'Leser tekst... ' + pct + '%');
          }
        }
      }).then(function(result) {
        setProgress(100, 'Ferdig!');
        console.log('OCR text:', result.data.text);
        
        extractData(result.data.text);
        
        setTimeout(function() {
          progressBox.classList.remove('active');
          uploadZone.classList.remove('processing');
          results.classList.add('active');
          showAlert('success', 'Dokument analysert! Kontroller at dataene stemmer.');
          render();
        }, 500);
        
      }).catch(function(err) {
        console.error('OCR error:', err);
        progressBox.classList.remove('active');
        uploadZone.classList.remove('processing');
        showAlert('error', 'OCR-feil: ' + (err.message || 'Ukjent feil'));
      });
    }
    
    function setProgress(pct, status) {
      document.getElementById('progressFill').style.width = pct + '%';
      document.getElementById('progressStatus').textContent = status;
    }
    
    function extractData(text) {
      // Invoice number
      var invMatch = text.match(/(?:invoice|inv|faktura|rechnung|facture|bill)[\s\-\.:]*(?:no|nr|#|number)?[\s\-\.:]*([A-Z0-9][\w\-\/]+)/i);
      if (invMatch) { document.getElementById('invNum').value = invMatch[1]; markFilled('f_invNum'); }
      
      // Date (multiple formats)
      var dateMatch = text.match(/(\d{1,2})[\.\/\-](\d{1,2})[\.\/\-](\d{4})/) || text.match(/(\d{4})[\.\/\-](\d{1,2})[\.\/\-](\d{1,2})/);
      if (dateMatch) {
        var y, m, d;
        if (dateMatch[1].length === 4) { y = dateMatch[1]; m = dateMatch[2]; d = dateMatch[3]; }
        else { y = dateMatch[3]; m = dateMatch[2]; d = dateMatch[1]; }
        document.getElementById('invDate').value = y + '-' + m.padStart(2,'0') + '-' + d.padStart(2,'0');
        markFilled('f_invDate');
      }
      
      // Amount
      var amounts = [];
      var amtMatches = text.match(/[\d\s]+[.,]\d{2}/g);
      if (amtMatches) {
        amtMatches.forEach(function(m) {
          var n = parseFloat(m.replace(/\s/g,'').replace(',','.'));
          if (n > 10 && n < 10000000) amounts.push(n);
        });
      }
      if (amounts.length > 0) {
        document.getElementById('invAmount').value = Math.max.apply(null, amounts).toFixed(2);
        markFilled('f_invAmount');
      }
      
      // Currency
      if (/EUR|‚Ç¨/.test(text)) document.getElementById('invCurrency').value = 'EUR';
      else if (/USD|\$/.test(text)) document.getElementById('invCurrency').value = 'USD';
      else if (/GBP|¬£/.test(text)) document.getElementById('invCurrency').value = 'GBP';
      else if (/SEK/.test(text)) document.getElementById('invCurrency').value = 'SEK';
      else if (/NOK/.test(text)) document.getElementById('invCurrency').value = 'NOK';
      
      // Company
      var compMatch = text.match(/([A-Za-z√Ä-√ø0-9\s\-\.&]+(?:GmbH|Ltd|Inc|AS|AB|AG|SA|BV|NV|ApS|LLC|Co\.|Corp))/i);
      if (compMatch) { document.getElementById('expName').value = compMatch[1].trim(); markFilled('f_expName'); }
      
      // Country detection
      var countryMap = {
        'DE': /germany|deutschland|gmbh|berlin|munich|hamburg/i,
        'CN': /china|chinese|beijing|shanghai|shenzhen/i,
        'SE': /sweden|sverige|swedish|stockholm|ab\b/i,
        'US': /usa|united states|american|new york|california/i,
        'GB': /uk|united kingdom|britain|london|ltd\b/i,
        'NL': /netherlands|holland|dutch|amsterdam|bv\b/i,
        'FR': /france|french|paris|lyon/i,
        'IT': /italy|italian|roma|milan/i,
        'DK': /denmark|danish|copenhagen|aps/i,
        'PL': /poland|polish|warsaw/i
      };
      for (var code in countryMap) {
        if (countryMap[code].test(text)) {
          document.getElementById('expCountry').value = code;
          document.getElementById('item1_origin').value = code;
          break;
        }
      }
      
      // Incoterms
      var incoMatch = text.match(/\b(EXW|FCA|CPT|CIP|DAP|DPU|DDP|FAS|FOB|CFR|CIF)\b/i);
      if (incoMatch) document.getElementById('incoterms').value = incoMatch[1].toUpperCase();
      
      // Weight
      var wtMatch = text.match(/(\d+[.,]?\d*)\s*(?:kg|kilo)/i);
      if (wtMatch) document.getElementById('item1_weight').value = wtMatch[1].replace(',','.');
      
      // HS code
      var hsMatch = text.match(/\b(\d{4})[.\s]?(\d{2})[.\s]?(\d{2,4})?\b/);
      if (hsMatch && !['2024','2025','2023','2022','1234','0000'].includes(hsMatch[1])) {
        document.getElementById('item1_hs').value = hsMatch[1] + '.' + hsMatch[2] + '.' + (hsMatch[3] || '00');
      }
    }
    
    function markFilled(id) {
      var el = document.getElementById(id);
      if (el) el.classList.add('filled');
    }
    
    // Demo data
    document.getElementById('demoBtn').onclick = function() {
      document.getElementById('invNum').value = 'INV-2024-001234';
      document.getElementById('invDate').value = '2024-11-20';
      document.getElementById('invAmount').value = '15000.00';
      document.getElementById('invCurrency').value = 'EUR';
      document.getElementById('expName').value = 'Schmidt Electronics GmbH';
      document.getElementById('expCountry').value = 'DE';
      document.getElementById('impName').value = 'Nordisk Import AS';
      document.getElementById('impOrg').value = '987654321';
      document.getElementById('incoterms').value = 'DAP';
      document.getElementById('transport').value = '3';
      document.getElementById('item1_desc').value = 'Elektroniske komponenter';
      document.getElementById('item1_hs').value = '8542.31.00';
      document.getElementById('item1_origin').value = 'DE';
      document.getElementById('item1_weight').value = '125';
      document.getElementById('item1_price').value = '165000';
      results.classList.add('active');
      showAlert('success', 'Demodata lastet!');
      render();
    };
    
    // Reset
    document.getElementById('resetBtn').onclick = function() {
      document.querySelectorAll('input,select').forEach(function(el) {
        if (el.type === 'date') el.value = '';
        else if (el.tagName === 'SELECT') el.selectedIndex = 0;
        else if (el.type !== 'file') el.value = '';
      });
      document.querySelectorAll('.field').forEach(function(el) { el.classList.remove('filled'); });
      results.classList.remove('active');
      previewBox.classList.remove('active');
      uploadZone.classList.remove('has-file');
      showAlert('info', 'Last opp en faktura (<strong>PDF, PNG eller JPG</strong>) for automatisk utfylling.');
      render();
    };
    
    function addRow() {
      rowCount++;
      var tr = document.createElement('tr');
      tr.innerHTML = '<td>'+rowCount+'</td><td><input type="text" id="item'+rowCount+'_desc"></td><td><input type="text" id="item'+rowCount+'_hs"></td><td><input type="text" id="item'+rowCount+'_origin" maxlength="2"></td><td><input type="number" id="item'+rowCount+'_weight"></td><td><input type="number" id="item'+rowCount+'_price"></td>';
      document.getElementById('itemsBody').appendChild(tr);
    }
    
    document.getElementById('exportOptions').onclick = function(e) {
      var opt = e.target.closest('.export-opt');
      if (opt) {
        document.querySelectorAll('.export-opt').forEach(function(o) { o.classList.remove('sel'); });
        opt.classList.add('sel');
        fmt = opt.dataset.fmt;
        render();
      }
    };
    
    function getData() {
      var items = [];
      for (var i = 1; i <= rowCount; i++) {
        var d = document.getElementById('item'+i+'_desc');
        if (d) {
          items.push({
            desc: d.value || '',
            hs: (document.getElementById('item'+i+'_hs')||{}).value||'',
            origin: (document.getElementById('item'+i+'_origin')||{}).value||'',
            weight: (document.getElementById('item'+i+'_weight')||{}).value||'',
            price: (document.getElementById('item'+i+'_price')||{}).value||''
          });
        }
      }
      return {
        invNum: document.getElementById('invNum').value,
        invDate: document.getElementById('invDate').value,
        invAmount: document.getElementById('invAmount').value,
        invCurrency: document.getElementById('invCurrency').value,
        expName: document.getElementById('expName').value,
        expCountry: document.getElementById('expCountry').value,
        impName: document.getElementById('impName').value,
        impOrg: document.getElementById('impOrg').value,
        incoterms: document.getElementById('incoterms').value,
        transport: document.getElementById('transport').value,
        items: items
      };
    }
    
    function genEDI(d) {
      var dt = d.invDate ? d.invDate.replace(/-/g,'') : new Date().toISOString().slice(0,10).replace(/-/g,'');
      var ref = (d.impOrg||'123456789') + dt + '0001';
      var l = ["UNA:+.? '"];
      l.push("UNB+UNOC:3+"+(d.impOrg||'SENDER')+":ZZZ+TOLLETATEN:ZZZ+"+dt+":1200+"+ref+"'");
      l.push("UNH+1+CUSDEC:D:96B:UN:TOLL01'");
      l.push("BGM+929+"+ref+"+9'");
      l.push("DTM+137:"+dt+":102'");
      l.push("LOC+22+441002'");
      if(d.expName) l.push("NAD+EX+++"+d.expName.substring(0,35)+"++++"+d.expCountry+"'");
      if(d.impName) l.push("NAD+IM+"+(d.impOrg||'')+":160++"+d.impName.substring(0,35)+"++++NO'");
      if(d.incoterms) l.push("TOD+6++"+d.incoterms+"'");
      if(d.transport) l.push("TDT+20++++"+d.transport+"'");
      if(d.invNum) l.push("RFF+IV:"+d.invNum+"'");
      if(d.invAmount) l.push("MOA+79:"+d.invAmount+":"+d.invCurrency+"'");
      d.items.forEach(function(it,i) {
        if(it.desc||it.hs) {
          l.push("LIN+"+(i+1)+"'");
          if(it.hs) l.push("TAX+COT+"+it.hs.replace(/\./g,'')+"'");
          if(it.desc) l.push("FTX+AAA+++"+it.desc.substring(0,70)+"'");
          if(it.origin) l.push("LOC+27+"+it.origin+"'");
          if(it.weight) l.push("MEA+AAE+G+KGM:"+it.weight+"'");
          if(it.price) l.push("MOA+38:"+it.price+":NOK'");
        }
      });
      l.push("CNT+2:"+(d.items.length||1)+"'");
      l.push("UNT+"+(l.length+1)+"+1'");
      l.push("UNZ+1+"+ref+"'");
      return l.join('\n');
    }
    
    function genJSON(d) { return JSON.stringify({faktura:{nr:d.invNum,dato:d.invDate,belop:d.invAmount,valuta:d.invCurrency},avsender:{navn:d.expName,land:d.expCountry},mottaker:{navn:d.impName,orgnr:d.impOrg},levering:{incoterms:d.incoterms,transport:d.transport},varer:d.items},null,2); }
    
    function genCSV(d) { var l=['Felt;Verdi','Fakturanr;'+d.invNum,'Dato;'+d.invDate,'Bel√∏p;'+d.invAmount+' '+d.invCurrency,'Avsender;'+d.expName,'','Nr;Beskrivelse;HS;Land;Vekt;Pris']; d.items.forEach(function(it,i){l.push((i+1)+';'+it.desc+';'+it.hs+';'+it.origin+';'+it.weight+';'+it.price);}); return l.join('\n'); }
    
    function genXML(d) { var x='<?xml version="1.0"?>\n<Declaration>\n  <Invoice>'+d.invNum+'</Invoice>\n  <Date>'+d.invDate+'</Date>\n  <Amount currency="'+d.invCurrency+'">'+d.invAmount+'</Amount>\n  <Consignor country="'+d.expCountry+'">'+d.expName+'</Consignor>\n  <Consignee id="'+d.impOrg+'">'+d.impName+'</Consignee>\n'; d.items.forEach(function(it){x+='  <Item><Desc>'+it.desc+'</Desc><HS>'+(it.hs||'').replace(/\./g,'')+'</HS></Item>\n';}); x+='</Declaration>'; return x; }
    
    function render() {
      var d = getData(), out = '';
      if (fmt==='edifact') out = genEDI(d);
      else if (fmt==='json') out = genJSON(d);
      else if (fmt==='csv') out = genCSV(d);
      else if (fmt==='xml') out = genXML(d);
      document.getElementById('output').textContent = out;
    }
    
    function copyOut() {
      var t = document.getElementById('output').textContent;
      navigator.clipboard ? navigator.clipboard.writeText(t).then(function(){alert('‚úÖ Kopiert!');}) : fallback(t);
    }
    function fallback(t) { var ta=document.createElement('textarea');ta.value=t;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);alert('‚úÖ Kopiert!'); }
    
    function downloadOut() {
      var t = document.getElementById('output').textContent;
      var ext = {edifact:'edi',json:'json',csv:'csv',xml:'xml'}[fmt];
      var b = new Blob([t],{type:'text/plain'});
      var a = document.createElement('a');
      a.href = URL.createObjectURL(b);
      a.download = 'tolldeklarasjon.' + ext;
      a.click();
    }
    
    function showAlert(type, msg) {
      var icons = {info:'üí°',success:'‚úÖ',error:'‚ùå',warning:'‚ö†Ô∏è'};
      alertBox.className = 'alert alert-' + type;
      alertBox.innerHTML = icons[type] + ' ' + msg;
    }
    
    document.addEventListener('input', render);
    render();
  </script>
</body>
</html>
